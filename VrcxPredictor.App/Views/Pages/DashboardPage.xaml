<Page x:Class="VrcxPredictor.App.Views.Pages.DashboardPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:conv="clr-namespace:VrcxPredictor.App.Converters"
      Title="Dashboard">

    <Page.Resources>
        <conv:PercentConverter x:Key="PercentConverter" />
        <conv:BoolToTextConverter x:Key="OnlineText" TrueText="上线" FalseText="下线" />
    </Page.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled"
                  VerticalAlignment="Stretch"
                  HorizontalAlignment="Stretch"
                  PanningMode="VerticalOnly">
        <Grid Margin="16" VerticalAlignment="Top">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Data source -->
            <ui:CardControl Grid.Row="0" Grid.ColumnSpan="2" Padding="16" Margin="0,0,0,12" HorizontalContentAlignment="Left">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.ColumnSpan="3" Text="数据源" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,8"/>

                    <TextBox Grid.Row="1" Grid.Column="0" Height="36"
                             Text="{Binding DbPath, UpdateSourceTrigger=PropertyChanged}"
                             VerticalContentAlignment="Center" />

                    <ui:Button Grid.Row="1" Grid.Column="1" Margin="8,0,0,0"
                               Content="浏览"
                               Command="{Binding BrowseDbCommand}" />

                    <ui:Button Grid.Row="1" Grid.Column="2" Margin="8,0,0,0"
                               Content="刷新表"
                               Command="{Binding RefreshTablesCommand}" />

                    <StackPanel Grid.Row="2" Grid.ColumnSpan="3" Orientation="Horizontal" Margin="0,10,0,0">
                        <TextBlock Text="表：" VerticalAlignment="Center" Opacity="0.8" />
                        <ComboBox Width="420" Margin="8,0,0,0"
                                  ItemsSource="{Binding Tables}"
                                  SelectedItem="{Binding SelectedTable}"
                                  IsEditable="False"/>

                        <TextBlock Text="显示名称：" VerticalAlignment="Center" Opacity="0.8" Margin="18,0,0,0"/>
                        <ComboBox Width="260" Margin="8,0,0,0"
                                  IsEditable="True"
                                  ItemsSource="{Binding SuggestedDisplayNames}"
                                  SelectedItem="{Binding DisplayName, UpdateSourceTrigger=PropertyChanged}"
                                  Text="{Binding DisplayName, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                </Grid>
            </ui:CardControl>

            <!-- Parameters -->
            <ui:CardControl x:Name="ParamsCard"
                            Grid.Row="1" Grid.Column="0"
                            Padding="16"
                            Margin="0,0,12,12"
                            HorizontalContentAlignment="Left">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.ColumnSpan="2" Text="参数" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,8"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="时区" Opacity="0.8" VerticalAlignment="Center" Margin="0,0,10,0"/>
                    <ComboBox Grid.Row="1" Grid.Column="1" Height="34" Width="220"
                              ItemsSource="{Binding TimeZones}"
                              SelectedItem="{Binding TimeZoneId}"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="记录时间" Opacity="0.8" VerticalAlignment="Center" Margin="0,10,10,0"/>
                    <ComboBox Grid.Row="2" Grid.Column="1" Height="34" Width="140" Margin="0,10,0,0"
                              ItemsSource="{Binding CreatedAtModes}"
                              SelectedItem="{Binding CreatedAtMode}"/>

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="半衰期(天)" Opacity="0.8" VerticalAlignment="Center" Margin="0,10,10,0"/>
                    <ui:NumberBox Grid.Row="3" Grid.Column="1" Width="140" Margin="0,10,0,0"
                                  Value="{Binding HalfLifeDays}" Minimum="0" Maximum="365"
                                  SpinButtonPlacementMode="Inline" />

                    <TextBlock Grid.Row="4" Grid.Column="0" Text="历史天数" Opacity="0.8" VerticalAlignment="Center" Margin="0,10,10,0"/>
                    <StackPanel Grid.Row="4" Grid.Column="1" Orientation="Horizontal" Margin="0,10,0,0">
                        <ui:NumberBox Width="120" Value="{Binding HistoryDays}" Minimum="7" Maximum="3650"
                                      SpinButtonPlacementMode="Inline" />
                        <TextBlock Text="Bin(分钟)" VerticalAlignment="Center" Opacity="0.8" Margin="12,0,0,0"/>
                        <ui:NumberBox Width="100" Margin="8,0,0,0"
                                      Value="{Binding BinMinutes}" Minimum="5" Maximum="60"
                                      SpinButtonPlacementMode="Inline" />
                    </StackPanel>

                    <TextBlock Grid.Row="5" Grid.Column="0" Text="周末/工作日分开" Opacity="0.8" VerticalAlignment="Center" Margin="0,10,10,0"/>
                    <CheckBox Grid.Row="5" Grid.Column="1" Margin="0,10,0,0"
                              IsChecked="{Binding SeparateWeekdayWeekend}" />

                    <TextBlock Grid.Row="6" Grid.Column="0" Text="最近N周权重" Opacity="0.8" VerticalAlignment="Center" Margin="0,10,10,0"/>
                    <ui:NumberBox Grid.Row="6" Grid.Column="1" Width="120" Margin="0,10,0,0"
                                  Value="{Binding RecentWeeks}" Minimum="0" Maximum="52"
                                  SpinButtonPlacementMode="Inline" />

                    <TextBlock Grid.Row="7" Grid.Column="0" Text="节假日" Opacity="0.8" VerticalAlignment="Center" Margin="0,10,10,0"/>
                    <TextBox Grid.Row="7" Grid.Column="1" Height="34" Margin="0,10,0,0"
                             Text="{Binding HolidayDatesText, UpdateSourceTrigger=PropertyChanged}"
                             ToolTip="YYYY-MM-DD，逗号分隔" />

                    <TextBlock Grid.Row="8" Grid.Column="0" Text="调休工作日" Opacity="0.8" VerticalAlignment="Center" Margin="0,10,10,0"/>
                    <TextBox Grid.Row="8" Grid.Column="1" Height="34" Margin="0,10,0,0"
                             Text="{Binding SpecialWorkdayDatesText, UpdateSourceTrigger=PropertyChanged}"
                             ToolTip="YYYY-MM-DD，逗号分隔" />
                </Grid>
            </ui:CardControl>

            <!-- Actions + Status + Explanation -->
            <ui:CardControl Grid.Row="1" Grid.Column="1"
                            Height="{Binding ActualHeight, ElementName=ParamsCard}"
                            Padding="16"
                            Margin="0,0,0,12"
                            HorizontalContentAlignment="Left">
                <StackPanel>
                    <TextBlock Text="操作" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,8"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <ui:Button Grid.Column="0" Height="38"
                                   Content="开始分析"
                                   Command="{Binding AnalyzeCommand}" />

                        <ui:Button Grid.Column="1" Height="38" Margin="10,0,0,0"
                                   Content="取消"
                                   Command="{Binding CancelCommand}"
                                   IsEnabled="{Binding IsBusy}" />
                    </Grid>

                    <ProgressBar Height="6" Margin="0,10,0,0"
                                 Value="{Binding Progress}" Maximum="1" />

                    <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                        <ui:SymbolIcon Symbol="Info24" />
                        <TextBlock Text="{Binding StatusText}" Opacity="0.85" VerticalAlignment="Center" Margin="10,0,0,0"/>
                    </StackPanel>

                    <Separator Margin="0,12,0,8"/>

                    <TextBlock Text="预测解释" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,6"/>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="平均间隔" Opacity="0.8" Margin="0,0,12,0"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding AvgIntervalText}" />

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="近7天活跃时段" Opacity="0.8" Margin="0,6,12,0"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding RecentActiveHoursText}" Margin="0,6,0,0"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="样本与置信度" Opacity="0.8" Margin="0,6,12,0"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding ConfidenceText}" Margin="0,6,0,0"/>
                    </Grid>
                </StackPanel>
            </ui:CardControl>

            <!-- Metrics cards -->
            <Grid Grid.Row="2" Grid.ColumnSpan="2" Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <ui:CardControl Grid.Column="0" Padding="14" Margin="0,0,12,0" HorizontalContentAlignment="Left">
                    <StackPanel>
                        <TextBlock Text="当前状态" Opacity="0.7"/>
                        <TextBlock Text="{Binding IsOnlineNow, Converter={StaticResource OnlineText}}"
                                   FontSize="22" FontWeight="SemiBold" Margin="0,4,0,0"/>
                        <TextBlock Text="{Binding LastEventTime, StringFormat=最后记录：{0:G}}" Opacity="0.7" Margin="0,6,0,0"/>
                    </StackPanel>
                </ui:CardControl>

                <ui:CardControl Grid.Column="1" Padding="14" Margin="0,0,12,0" HorizontalContentAlignment="Left">
                    <StackPanel>
                        <TextBlock Text="未来2小时" Opacity="0.7"/>
                        <TextBlock Text="{Binding ProbNext2Hours, Converter={StaticResource PercentConverter}}"
                                   FontSize="22" FontWeight="SemiBold" Margin="0,4,0,0"/>
                        <TextBlock Text="至少上线一次的概率" Opacity="0.7" Margin="0,6,0,0"/>
                    </StackPanel>
                </ui:CardControl>

                <ui:CardControl Grid.Column="2" Padding="14" Margin="0,0,12,0" HorizontalContentAlignment="Left">
                    <StackPanel>
                        <TextBlock Text="规律性" Opacity="0.7"/>
                        <TextBlock Text="{Binding StabilityLabel}" FontSize="22" FontWeight="SemiBold" Margin="0,4,0,0"/>
                        <TextBlock Text="{Binding StabilityStdHours, StringFormat=Std≈{0:0.00}小时}" Opacity="0.7" Margin="0,6,0,0"/>
                    </StackPanel>
                </ui:CardControl>

                <ui:CardControl Grid.Column="3" Padding="14" HorizontalContentAlignment="Left">
                    <StackPanel>
                        <TextBlock Text="最佳窗口(24h)" Opacity="0.7"/>
                        <TextBlock Text="{Binding BestWindowPeakProb, Converter={StaticResource PercentConverter}}"
                                   FontSize="22" FontWeight="SemiBold" Margin="0,4,0,0"/>
                        <TextBlock Text="{Binding BestWindowStart, StringFormat={}{0:G}}" Opacity="0.7" Margin="0,6,0,0"/>
                    </StackPanel>
                </ui:CardControl>
            </Grid>

        </Grid>
    </ScrollViewer>
</Page>
